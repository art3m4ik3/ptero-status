"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Functions=void 0;const discord_js_1=require("discord.js"),jspteroapi_1=require("jspteroapi"),defaultSettings_1=require("../config/defaultSettings"),errorEmbed_1=require("../embeds/errorEmbed"),JSPteroAPIError_1=require("../embeds/JSPteroAPIError");class Functions{constructor(e){this.bot=e,this.waitForArray=(e,t=1400)=>new Promise((s=>{const r=()=>{e.length?s():setTimeout(r,t)};r()})),this.getObjValue=(e,t)=>{const s=t.split(".");return 1===s.length?e:s.reduce(((e,t)=>(e||{})[t]),e)},this.selectFromArray=async(e,t,s,r,i,o,n,a)=>{if(1===s.length)return s[0];let l=s.map((e=>({label:this.getObjValue(e,r),description:a&&this.getObjValue(e,a)?this.getObjValue(e,a).slice(0,99):void 0,value:`${this.getObjValue(e,i)}`})));l.length>25&&(l=l.slice(0,25));const d=new discord_js_1.StringSelectMenuBuilder({maxValues:1,custom_id:"select",placeholder:o,options:l}),c=new discord_js_1.ActionRowBuilder({components:[d]}),u=this.bot.embed({title:o,description:n},{settings:t}),h=await e.editReply({embeds:[u],components:[c]}),g=async t=>t.user.id===e.user.id&&"select"===t.customId&&(await t.deferUpdate(),!0);try{const t=await h.awaitMessageComponent({filter:g,componentType:discord_js_1.ComponentType.SelectMenu,time:6e4}),o=s.find((e=>`${this.getObjValue(e,i)}`===t.values[0]));if(!o)throw new Error(this.bot.t("not_found.main"));const n=d.setPlaceholder(this.getObjValue(o,r)).setDisabled(!0),a=new discord_js_1.ActionRowBuilder({components:[n]});return await e.editReply({embeds:[u],components:[a]}),o}catch(e){throw new Error(`⏰ ${this.bot.t("errors.timeout")}`)}},this.getConsole=async(e,t,s,r=10,i)=>{const o=i??await e.getServerResources(t);if("offline"===o.current_state||o.is_suspended)throw new Error(o.is_suspended?this.bot.t("errors.server_susp"):this.bot.t("errors.server_off"));const n=[];s&&await e.sendCommand(t,s);const a=await e.startConsoleConnection(t);return a.on("console output",(e=>n.push(e))),a.on("auth success",(()=>{a.send("send logs")})),await this.waitForArray(n),a.close(),n.slice(n.length-r,n.length)},this.requestFollowUp=async(e,t,s,r,i,o=!0,n)=>{const a=this.bot.embed({title:s,description:r,fields:i,footer:n?{text:n}:void 0},{settings:t}),l=o?await e.followUp({embeds:[a],fetchReply:!0,ephemeral:!0,components:[]}):await e.editReply({embeds:[a],components:[]}),d=t=>t.author.id===e.member?.user.id;try{const e=await l.channel.awaitMessages({filter:d,errors:["time"],time:6e4,max:1}),t=e?.first();if(!t||!t.content)throw new Error(this.bot.t("errors.no_msg"));return await new Promise((e=>setTimeout(e,250))),await t.delete().catch((()=>{})),t.content}catch(r){if(r instanceof Error)throw r;return await e.followUp({embeds:[this.bot.embed({title:s,description:`⏰ ${this.bot.t("errors.timeout")}`},{settings:t})],ephemeral:!0}),"cancel"}},this.handleNoResult=async(e,t,s=this.bot.t("errors.no_res"),r,i)=>{const o={embeds:[this.bot.embed({title:`🛑 ${s} 🛑`,description:r??this.bot.t("errors.try_again")},{settings:t})]};i&&(o.components=i),await e.editReply(o)},this.handleError=async(e,t,s,r=!1)=>{const i=s instanceof jspteroapi_1.JSPteroAPIError?(0,JSPteroAPIError_1.makeJSPteroAPIErrorEmbed)(this.bot,t,s):(0,errorEmbed_1.makeErrorEmbed)(this.bot,t,s);r?e.followUp({embeds:[i],ephemeral:!0}):e.editReply({embeds:[i],components:[]})},this.getServerBySearch=async(e,t,s,r)=>{const i=e.options.getString("search",!0),o=await s.getAllServers({egg:!0},{filter:i,filterBy:"*"},r).then((e=>e.filter((e=>!e.attributes.is_suspended))));return 0===o.length?(this.handleNoResult(e,t,this.bot.t("not_found.server")),!1):(await this.selectFromArray(e,t,o,"attributes.name","attributes.identifier",this.bot.t("servers.sel_server"),this.bot.t("servers.search_multiple_res"),"attributes.relationships.egg.attributes.name")).attributes}}getSettings(e){if(!e)return defaultSettings_1.defaultGuildSettings;const t=this.bot.settings.get(e.id)||{};return{...defaultSettings_1.defaultGuildSettings,...t}}getSettingsById(e){if(!e)return defaultSettings_1.defaultGuildSettings;const t=this.bot.settings.get(e)||{};return{...defaultSettings_1.defaultGuildSettings,...t}}getUserSettings(e,t){if(!e||!t)return defaultSettings_1.defaultUserSettings;const s=this.bot.userSettings.get(`${e.id}|${t.id}`);return{...defaultSettings_1.defaultUserSettings,...s}}permlevel(e,t){let s=0;const r=this.bot.config.permLevels.slice(0).sort(((e,t)=>e.level<t.level?1:-1));for(;r.length;){const i=r.shift();if(i&&i.check({interaction:e,settings:t})){s=i.level;break}}return s}unlimitedOrValue(e){return e?`${e}`:this.bot.e("unlimited")}}exports.Functions=Functions;