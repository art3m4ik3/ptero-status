"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.cmd=void 0;const discord_js_1=require("discord.js"),paginationButton_1=require("../buttons/paginationButton"),powerButtons_1=require("../buttons/powerButtons"),Command_1=require("../classes/Command"),console_1=require("../embeds/console"),run=async(e,{bot:t,interaction:o,client:s,settings:n})=>{const r=[];let a={state:"Unknown",network:{rx_bytes:0,tx_bytes:0},memory_limit_bytes:0,uptime:0,cpu_absolute:0,disk_bytes:0,memory_bytes:0};const i=await s.startConsoleConnection(e.identifier);i.on("console output",(e=>r.push(e))),i.on("stats",(e=>a=JSON.parse(e))),i.on("auth success",(()=>{i.send("send logs")}));const c=(0,powerButtons_1.powerButtonRow)(t),d=new discord_js_1.ButtonBuilder({...paginationButton_1.refreshButton}).setLabel(t.t("pagination.refresh")),u=new discord_js_1.ActionRowBuilder({components:[d]});if(await new Promise((e=>{const t=()=>{"Unknown"!==a.state?e(!0):setTimeout(t,250)};t()})),"offline"===a.state)return await t.functions.handleError(o,n,new Error(t.t("errors.server_off")));await t.functions.waitForArray(r,250);const m=(await o.editReply({embeds:[(0,console_1.makeConsoleEmbed)(t,n,e,r,{values:a})],components:[c,u]})).createMessageComponentCollector({filter:async e=>o.member?.user.id===e.member?.user.id&&("start"===e.customId||"restart"===e.customId||"stop"===e.customId||"kill"===e.customId||"refresh"===e.customId),time:12e4,componentType:discord_js_1.ComponentType.Button});i.on("SOCKET_CLOSE",(()=>{m.stop()}));const l=async()=>{const s=m._timeout;await o.editReply({embeds:[(0,console_1.makeConsoleEmbed)(t,n,e,r,{timeout:s,values:a})]})},p=setInterval(l,2350);m.on("collect",(async e=>{i.send("send stats"),await e.deferUpdate(),"refresh"!==e.customId&&i.send("set state",e.customId),await l(),m.resetTimer()})),m.on("end",(async()=>{clearInterval(p),i.close();const s=(new discord_js_1.ActionRowBuilder).addComponents(d.setDisabled(!0));await o.editReply({embeds:[(0,console_1.makeConsoleEmbed)(t,n,e,r,{values:a})],components:[s]})}))};exports.cmd=(new Command_1.CommandWithClientServer).setName("console").setDescription("console").setCategory("pterodactyl").setRun(run);