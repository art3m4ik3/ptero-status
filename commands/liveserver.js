"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.cmd=void 0;const Command_1=require("../classes/Command"),discord_js_1=require("discord.js"),jspteroapi_1=require("jspteroapi"),liveserver_1=require("../embeds/liveserver"),powerButtons_1=require("../buttons/powerButtons"),removeLiveServerGuildSettings=(e,t,s,r)=>{const i=t.liveServers.indexOf(s);t.liveServers.splice(i,1),e.settings.set(r,t)},onLiveServerUpdate=async e=>{const{bot:t,settings:s,liveServer:{serverUUID:r,console:i,powerButtons:n},client:o,message:a}=e;try{const e=await o.getServerInfo(r,{egg:!0}),l=await o.getServerResources(r).catch((()=>{})),d=i?await t.functions.getConsole(o,r,void 0,void 0,l).catch((()=>{})):void 0,c=(0,liveserver_1.makeLiveServerEmbed)(t,s,e,l,d),v=n?[(0,powerButtons_1.powerButtonRow)(t)]:[];await a.edit({embeds:[c],components:[...v]}),t.logger.cmd(`${a.guild?.name} (${a.guild?.id}) Live Server ${e.name} (${e.identifier}) was updated`)}catch(r){if(await a.edit({embeds:[t.embed({title:"Failed to fetch server"},{settings:s})]}),r instanceof jspteroapi_1.JSPteroAPIError)t.logger.error(r.ERRORS.join("\n"));else{removeLiveServerGuildSettings(t,s,e.liveServer,a.guildId);const r=t.liveServerIntervals.get(a.guildId+e.liveServer.serverUUID);r&&clearInterval(r)}}},collectPowerButtons=async(e,t,s,r,i,n)=>{const o=s.createMessageComponentCollector({filter:async t=>{if("start"===t.customId||"restart"===t.customId||"stop"===t.customId||"kill"===t.customId){if(n)return!0;if(t.user.id===i)return!0;const o=e.userSettings.get(`${s.guildId}|${t.user.id}`);if(!o||!o.token||""===o.token)return!1;const a=new jspteroapi_1.Client(e.config.pteroHost,o.token);if(await a.getServerInfo(r).catch((()=>null)))return!0}return!1},componentType:discord_js_1.ComponentType.Button});o.on("collect",(async s=>{await s.deferUpdate(),await t.setPowerState(r,s.customId).catch((()=>null));const i=await t.getServerInfo(r).catch((()=>null));e.logger.cmd(`${s.guild?.name} (${s.guild?.id}) ${s.user.username} (${s.user.id}) performed ${s.customId} on ${i?.name} (${r})`)}))},run=async({bot:e,settings:t,interaction:s,client:r,adminUser:i})=>{const n=s.options.getSubcommand();if(!s.guildId)return;const o=await e.functions.getServerBySearch(s,t,r,i);if(o){if(o.is_suspended)return await e.functions.handleError(s,t,new Error(e.t("errors.server_susp")));if("setup"===n){const i=s.options.getChannel("channel",!0),n=s.options.getBoolean("console",!1)??!1,a=s.options.getBoolean("powerbuttons",!1)??!1,l=s.options.getBoolean("allowall",!1)??!1;if(i.type!==discord_js_1.ChannelType.GuildText)return e.functions.handleError(s,t,new Error(e.t("errors.channel_not_text")));const d={serverUUID:o.uuid,channelId:i.id,userId:s.user.id,messageId:"",console:n,powerButtons:a,allowAll:l},c=await i.send({embeds:[e.embed({title:o.name},{settings:t})]});a&&collectPowerButtons(e,r,c,o.uuid,s.user.id,l),d.messageId=c.id,e.settings.set(s.guildId,t.liveServers,"liveServers"),e.settings.push(s.guildId,d,"liveServers");const v=setInterval((()=>{onLiveServerUpdate({bot:e,settings:t,liveServer:d,client:r,message:c})}),6e4);e.liveServerIntervals.set(s.guildId+d.serverUUID,v),await s.editReply({embeds:[e.embed({title:e.t("liveserver.set_up",{name:o.name})},{settings:t})]})}else if("delete"===n){if(0===t.liveServers.length)return void await s.editReply({embeds:[e.embed({title:e.t("errors.no_live_servers")},{settings:t})]});const r=t.liveServers.find((e=>e.serverUUID===o.uuid));if(!r)return void await s.editReply({embeds:[e.embed({title:e.t("live_server_not_found",{name:o.name})},{settings:t})]});const i=e.liveServerIntervals.get(s.guildId+r.serverUUID);i&&clearInterval(i);const n=await(s.guild?.channels.fetch(r.channelId).catch((()=>{})));if(n&&n.isTextBased()){const e=await n.messages.fetch(r.messageId).catch((()=>{}));e&&await e.delete().catch((()=>{}))}removeLiveServerGuildSettings(e,t,r,s.guildId),s.editReply({embeds:[e.embed({title:e.t("liveserver.deleted",{name:o.name})},{settings:t})]})}}},setup=async({bot:e,guilds:t})=>{t.forEach((async t=>{const s=e.functions.getSettings(t);if(0===s.liveServers.length)return;const r=new jspteroapi_1.Client(e.config.pteroHost,s.pteroClientToken);for(const i of s.liveServers){const n=await t.channels.fetch(i.channelId).catch((()=>null));if(!n||n.type!==discord_js_1.ChannelType.GuildText){removeLiveServerGuildSettings(e,s,i,t.id);continue}const o=await n.messages.fetch(i.messageId).catch((()=>null));if(!o){removeLiveServerGuildSettings(e,s,i,t.id);continue}i.powerButtons&&collectPowerButtons(e,r,o,i.serverUUID,i.userId,i.allowAll);const a=setInterval((()=>{onLiveServerUpdate({bot:e,settings:s,liveServer:i,client:r,message:o})}),6e4);e.liveServerIntervals.set(t.id+i.serverUUID,a)}}))};exports.cmd=(new Command_1.CommandWithAdmin).setName("liveserver").setDescription("liveserver.main").setPermNameClient("administrator").setRun(run).setSetup(setup).addSubcommand((e=>e.setName("setup").setDescription("liveserver.setup").addStringOption((e=>e.setName("search").setDescription("common.search_server_*").setRequired(!0))).addChannelOption((e=>e.setName("channel").setDescription("liveserver.channel").setRequired(!0))).addBooleanOption((e=>e.setName("console").setDescription("liveserver.console").setRequired(!1))).addBooleanOption((e=>e.setName("powerbuttons").setDescription("liveserver.powerbuttons").setRequired(!1))).addBooleanOption((e=>e.setName("allowall").setDescription("liveserver.allow_all").setRequired(!1))))).addSubcommand((e=>e.setName("delete").setDescription("liveserver.delete").addStringOption((e=>e.setName("search").setDescription("common.search_server_*")))));