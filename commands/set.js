"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.cmd=void 0;const jspteroapi_1=require("jspteroapi"),discord_js_1=require("discord.js"),node_fs_1=require("node:fs"),Command_1=require("../classes/Command"),colors_json_1=require("../config/colors.json"),roleListFromID=async(e,t)=>{const o=[];return await Promise.all(e.map((async e=>{const s=await t.roles.fetch(e);s&&o.push(s)}))),o.length>0?o.map(((e,t)=>`${e.toString()} ${(t+1)%3==0?"\n":""}`)).join(""):"No Roles Set"},run=async({interaction:e,settings:t,bot:o})=>{const s=e.options.getString("color"),i=e.options.getRole("role"),n=e.options.getRole("role"),r=e.options.getString("client"),a=e.options.getString("admin"),d=e.options.getString("lng"),l=e.options.getSubcommand();if(!e.guild)return;const m=e.guild;o.settings.has(m.id)||o.settings.set(m.id,{});const c=async()=>{};if("show"===l){const s=new jspteroapi_1.Client(o.config.pteroHost,t.pteroClientToken,void 0,!0),i=new jspteroapi_1.Application(o.config.pteroHost,t.pteroToken,void 0,!0),n=await s.testAPI(!1)?o.t("common.valid"):o.t("common.invalid"),r=await i.testAPI(!1)?o.t("common.valid"):o.t("common.invalid"),a=e.guild.preferredLocale.toLowerCase(),d=o.embed({title:o.t("set.settings"),description:`PteranodonBot@${o.config.version}`,fields:[{name:o.t("set.lng"),value:""===t.lngOverride?a.toUpperCase():t.lngOverride.toUpperCase()},{name:o.t("set.admin_roles"),value:await roleListFromID(t.adminRoles,m)},{name:o.t("set.tokens"),value:`${o.t("set.token.client_token",{valid:n})}\n            ${t.admin?o.t("set.token.admin_token",{valid:r}):""}`},{name:`âŸµ ${o.t("set.embedcolor.color")}`,value:colors_json_1.colors.find((e=>e.value===t.embedColor))?.name??t.embedColor}]},{settings:t});return void await e.editReply({embeds:[d]})}let p,g;if(s)o.settings.set(m.id,s,"embedColor"),t.embedColor=s,p=`${o.t("set.embedcolor.set_color",{color:colors_json_1.colors.find((e=>e.value===s))?.name??s})}`;else if(d)o.settings.set(m.id,d,"lngOverride"),p=`${o.t("set.changed_lng",{lng:`**${d.toUpperCase()}**`})}`,await c();else if("add"===l&&i&&i instanceof discord_js_1.Role)t.adminRoles.includes(i.id)?p=o.t("set.admin_role.alrd_set",{role:i.name}):(o.settings.set(m.id,[...t.adminRoles,i.id],"adminRoles"),t.adminRoles.push(i.id),p=o.t("set.admin_role.added_role",{role:i.name}),g=o.t("set.admin_role.all_roles",{roles:`\n${await roleListFromID(t.adminRoles,m)}`}),await c());else if("remove"===l&&n&&n instanceof discord_js_1.Role)t.adminRoles.includes(n.id)?(o.settings.set(m.id,[...t.adminRoles.filter((e=>e!==n.id))],"adminRoles"),t.adminRoles.splice(t.adminRoles.indexOf(n.id),1),p=o.t("set.admin_role.removed_role",{role:n.name}),g=o.t("set.admin_role.all_roles",{roles:`\n${await roleListFromID(t.adminRoles,m)}`}),await c()):p=o.t("set.admin_role.not_set",{role:n.name});else if(r){let e=!1;const t=new jspteroapi_1.Client(o.config.pteroHost,r,void 0,!0);try{e=await t.testAPI()}catch(t){o.logger.error(t),console.log(t),e=!1}if(a&&e){const t=new jspteroapi_1.Application(o.config.pteroHost,a,void 0,!0);try{e=await t.testAPI()}catch(t){o.logger.error(t),console.log(t),e=!1}}e?(o.settings.set(m.id,r,"pteroClientToken"),a&&o.settings.set(m.id,a,"pteroToken"),o.settings.set(m.id,!!a,"admin"),p=o.t("set.token.success"),await c()):p=o.t("set.token.invalid")}const _=o.embed({title:p??o.t("common.error"),description:g},{settings:t});e.editReply({embeds:[_]})},lngs=(0,node_fs_1.readdirSync)(`${__dirname}/../locales`,{withFileTypes:!0}).filter((e=>e.isDirectory())).map((e=>({name:e.name,value:e.name})));exports.cmd=(new Command_1.Command).setName("set").setDescription("set.main").setPermNameAdmin("administrator").setPermNameClient("administrator").setRun(run).addSubcommandGroup((e=>e.setName("adminrole").setDescription("set.admin_role.main").addSubcommand((e=>e.setName("add").setDescription("set.admin_role.add").addRoleOption((e=>e.setName("role").setDescription("set.admin_role.add_role").setRequired(!0))))).addSubcommand((e=>e.setName("remove").setDescription("set.admin_role.rem").addRoleOption((e=>e.setName("role").setDescription("set.admin_role.rem_role").setRequired(!0))))))).addSubcommand((e=>e.setName("embedcolor").setDescription("set.embedcolor.main").addStringOption((e=>e.setName("color").setDescription("set.embedcolor.color").addChoices(...colors_json_1.colors).setRequired(!0))))).addSubcommand((e=>e.setName("tokens").setDescription("set.token.main").addStringOption((e=>e.setName("client").setDescription("set.token.client").setRequired(!0))).addStringOption((e=>e.setName("admin").setDescription("set.token.admin"))))).addSubcommand((e=>e.setName("language").setDescription("set.set_lng").addStringOption((e=>e.setName("lng").setDescription("set.lng").addChoices(...lngs).setRequired(!0))))).addSubcommand((e=>e.setName("show").setDescription("set.token.show")));