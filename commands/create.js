"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.cmd=void 0;const Command_1=require("../classes/Command"),aserver_1=require("../embeds/aserver"),user_1=require("../embeds/user"),run=async({bot:e,interaction:t,app:a,settings:s})=>{const i=t.options.getSubcommand();if("user"!==i){if("server_template"===i){const i=t.options.getString("template",!0),n=t.options.getString("name",!0),r=t.options.getString("node",!0),o=t.options.getString("owner",!0),d=s.serverTemplates[i];if(!d)return e.functions.handleNoResult(t,s,e.t("not_found.template"));const l=await a.getAllNodes(void 0,{filterBy:"name",filter:r});if(0===l.length)return e.functions.handleNoResult(t,s,e.t("not_found.node"));const u=await e.functions.selectFromArray(t,s,l,"attributes.name","attributes.id",e.t("create.sel_node"),void 0,"attributes.description");let m=await a.getAllUsers(void 0,{filter:o,filterBy:"username"});if(0===m.length&&(m=await a.getAllUsers(void 0,{filter:o,filterBy:"email"})),0===m.length)return e.functions.handleNoResult(t,s,e.t("not_found.owner"));const c=await e.functions.selectFromArray(t,s,m,"attributes.username","attributes.id",e.t("create.sel_owner"),void 0,"attributes.email"),p=await a.getAllAllocations(u.attributes.id);if(0===p.length)return e.functions.handleNoResult(t,s,e.t("not_found.allocation"));const g=p.find((({attributes:e})=>!1===e.assigned));if(!g)return e.functions.handleNoResult(t,s,e.t("create.no_free_alloc"));const b=await a.createServer(n,c.attributes.id,"",d.nest,d.egg,g.attributes.id,void 0,d.env,d.cpu,d.memory,d.disk,d.database,d.allocation,d.backup,void 0,d.dockerImg,d.swap,void 0,d.autoStart,{allocations:!0,user:!0,egg:!0,databases:!0}),f=(0,aserver_1.makeAServerEmbed)(e,s,b);await t.editReply({embeds:[f],components:[]})}else if("server"===i){const i=t.options.getString("name",!0),n=t.options.getString("node",!0),r=t.options.getString("owner",!0),o=t.options.getNumber("cpu")??0,d=t.options.getNumber("memory")??0,l=t.options.getNumber("disk")??0,u=t.options.getNumber("swap")??-1,m=t.options.getNumber("database")??0,c=t.options.getNumber("allocation")??0,p=t.options.getNumber("backup")??0,g=t.options.getBoolean("autostart")??!1,b=await a.getAllNests({eggs:!0});if(0===b.length)return e.functions.handleNoResult(t,s,e.t("not_found.nest"));const f=await e.functions.selectFromArray(t,s,b,"attributes.name","attributes.id",e.t("template.sel_nest"));if(!f.attributes.relationships?.eggs?.data||!Array.isArray(f.attributes.relationships?.eggs?.data))return e.functions.handleNoResult(t,s);const N=await e.functions.selectFromArray(t,s,f.attributes.relationships.eggs.data,"attributes.name","attributes.id",e.t("template.sel_egg"),void 0,"attributes.description");if("object"==typeof N.attributes.docker_images&&(N.attributes.docker_images=Object.values(N.attributes.docker_images)),0===N.attributes.docker_images.length)return e.functions.handleNoResult(t,s);const v=await e.functions.selectFromArray(t,s,N.attributes.docker_images,"","",e.t("template.sel_docker")),_=await a.getEggInfo(f.attributes.id,N.attributes.id,{variables:!0});if(void 0===_.relationships?.variables?.data)return e.functions.handleNoResult(t,s);const w={};for(const{attributes:a}of _.relationships.variables.data){const i=await e.functions.requestFollowUp(t,s,a.name.toLocaleUpperCase(),`**${e.t("template.type_value")}\n${e.t("template.for_default",{default:"def",empty:"empty"})}**\n\n${a.description.slice(0,99)}\n\n**${e.t("template.rules").toUpperCase()}**: \`\`\`${a.rules}\`\`\`\n**${e.t("template.default_val")}**: \`\`\`${""!==a.default_value?a.default_value.toString():"â€‹"}\`\`\``,void 0,!1);w[a.env_variable]="def"===i||"cancel"===i?a.default_value:"empty"===i?"":i}const S=await a.getAllNodes(void 0,{filterBy:"name",filter:n});if(0===S.length)return e.functions.handleNoResult(t,s,e.t("not_found.node"));const h=await e.functions.selectFromArray(t,s,S,"attributes.name","attributes.id",e.t("create.sel_node"),void 0,"attributes.description");let y=await a.getAllUsers(void 0,{filter:r,filterBy:"username"});if(0===y.length&&(y=await a.getAllUsers(void 0,{filter:r,filterBy:"email"})),0===y.length)return e.functions.handleNoResult(t,s,e.t("not_found.owner"));const R=await e.functions.selectFromArray(t,s,y,"attributes.username","attributes.id",e.t("create.sel_owner"),void 0,"attributes.email"),A=await a.getAllAllocations(h.attributes.id);if(0===A.length)return e.functions.handleNoResult(t,s,e.t("not_found.allocation"));const D=A.find((({attributes:e})=>!1===e.assigned));if(!D)return e.functions.handleNoResult(t,s,e.t("create.no_free_alloc"));const O=await a.createServer(i,R.attributes.id,"",f.attributes.id,_.id,D.attributes.id,void 0,w,o,d,l,m,c,p,void 0,v,u,void 0,g,{allocations:!0,user:!0,egg:!0,databases:!0}),k=(0,aserver_1.makeAServerEmbed)(e,s,O);await t.editReply({embeds:[k],components:[]})}}else{const i=t.options.getString("email",!0),n=t.options.getString("username",!0),r=t.options.getString("first_name",!0),o=t.options.getString("last_name",!0),d=t.options.getBoolean("admin")??!1,l=t.options.getString("password")??void 0,u=await a.createUser(n,r,o,i,l,d);await t.editReply({embeds:[(0,user_1.makeUserEmbed)(e,s,u)]})}};exports.cmd=(new Command_1.CommandWithAdmin).setName("create").setDescription("create.main").setCategory("pterodactyl_admin").setRun(run).addSubcommand((e=>e.setName("user").setDescription("create.user").addStringOption((e=>e.setName("email").setDescription("create.email").setRequired(!0))).addStringOption((e=>e.setName("username").setDescription("create.username").setRequired(!0))).addStringOption((e=>e.setName("first_name").setDescription("create.first_name").setRequired(!0))).addStringOption((e=>e.setName("last_name").setDescription("create.last_name").setRequired(!0))).addBooleanOption((e=>e.setName("admin").setDescription("create.admin"))).addStringOption((e=>e.setName("password").setDescription("create.password"))))).addSubcommand((e=>e.setName("server_template").setDescription("create.server").addStringOption((e=>e.setName("template").setDescription("create.template").setRequired(!0))).addStringOption((e=>e.setName("name").setDescription("create.name").setRequired(!0))).addStringOption((e=>e.setName("node").setDescription("create.node").setRequired(!0).addChoices(...globalThis.commandArgs.nodes))).addStringOption((e=>e.setName("owner").setDescription("create.owner").setRequired(!0))))).addSubcommand((e=>e.setName("server").setDescription("create.server").addStringOption((e=>e.setName("name").setDescription("create.name").setRequired(!0))).addStringOption((e=>e.setName("node").setDescription("create.node").setRequired(!0).addChoices(...globalThis.commandArgs.nodes))).addStringOption((e=>e.setName("owner").setDescription("create.owner").setRequired(!0))).addNumberOption((e=>e.setName("cpu").setDescription("template.cpu"))).addNumberOption((e=>e.setName("memory").setDescription("template.memory"))).addNumberOption((e=>e.setName("disk").setDescription("template.disk"))).addNumberOption((e=>e.setName("swap").setDescription("template.swap"))).addNumberOption((e=>e.setName("backup").setDescription("template.backup"))).addNumberOption((e=>e.setName("allocation").setDescription("template.allocation"))).addNumberOption((e=>e.setName("database").setDescription("template.database"))).addBooleanOption((e=>e.setName("autostart").setDescription("template.autostart")))));