"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.run=void 0;const jspteroapi_1=require("jspteroapi"),invalidToken_1=require("../embeds/invalidToken"),permissionError_1=require("../embeds/permissionError"),run=async(e,n)=>{if(n.isChatInputCommand()){if(!n.guild)return;const{commandName:i}=n,r=e.commands.get(i);if(!r)return;const t=e.functions.getSettings(n.guild),o=e.functions.getUserSettings(n.guild,n.user);let s=n.guild.preferredLocale.toLowerCase();""!==t.lngOverride&&(s=t.lngOverride),await e.i18.changeLanguage(s),n.member||await n.guild.members.fetch(n.user);const a=e.functions.permlevel(n,t),m=e.config.permLevels.find((e=>e.level===a))?.name??"Unknown";if(a<r.getPermLevel(e,t.admin)){const i=(0,permissionError_1.makePermissionErrorEmbed)(e,a,m,r,t.admin);return await n.reply({embeds:[i],ephemeral:!0})}const d=a>=3;await n.deferReply({ephemeral:e.config.ephermal&&r.ephemeral,fetchReply:!0});const l=jspteroapi_1.Client.bind(void 0,e.config.pteroHost);let p,u;if(r.usingPteroAdminApi)p=new l(t.pteroClientToken,void 0,!0),u=new jspteroapi_1.Application(e.config.pteroHost,t.pteroToken,void 0,!0);else if(r.usingPteroApi)if(d)p=new l(t.pteroClientToken,void 0,!0);else if(t.admin){if(!o.token){const i=(0,invalidToken_1.makeInvalidTokenEmbed)(e,t);return await n.reply({embeds:[i]})}p=new l(o.token,void 0,!0)}e.logger.cmd(`${n.guild.name} (${n.guild.id}): ${e.t(m)} ${n.user.username} (${n.user.id}) ran command ${r.name}`);const c={bot:e,interaction:n,settings:t,permLevel:a,permName:m,adminUser:d&&t.admin};await r.preRun(c,{app:u,client:p}).catch((i=>e.functions.handleError(n,t,i)))}};exports.run=run;